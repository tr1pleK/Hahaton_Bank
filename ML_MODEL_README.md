# Модель машинного обучения для классификации транзакций

## Описание

Модель машинного обучения автоматически классифицирует банковские транзакции по категориям расходов на основе:
- Описания транзакции (RefNo)
- Суммы транзакции (Withdrawal/Deposit)
- Даты транзакции
- Типа транзакции (расход/доход)

## Архитектура модели

Модель использует:
- **TF-IDF векторизацию** для обработки текстовых описаний
- **Random Forest Classifier** для классификации
- **StandardScaler** для нормализации числовых признаков

### Признаки модели:
1. **Текстовые признаки**: TF-IDF векторы из описания транзакции (RefNo)
2. **Числовые признаки**:
   - Сумма транзакции
   - Тип транзакции (расход/доход)
   - День недели
   - День месяца
   - Месяц

## Категории

Модель классифицирует транзакции в следующие категории:

### Расходы:
- **Продукты** (Food) - покупка продуктов питания
- **Транспорт** (Transport) - транспортные расходы
- **Коммунальные услуги** (Rent) - аренда, коммунальные платежи
- **Одежда** (Shopping) - покупки одежды и товаров
- **Прочие расходы** (Misc) - прочие расходы

### Доходы:
- **Зарплата** (Salary) - заработная плата

## Обучение модели

### Требования

Убедитесь, что установлены все зависимости:
```bash
pip install -r requirements.txt
```

### Формат данных

CSV файл должен содержать следующие колонки:
- `Date` - Дата транзакции
- `Category` - Категория транзакции (Rent, Misc, Food, Salary, Shopping, Transport)
- `RefNo` - Описание/идентификатор транзакции
- `Withdrawal` - Сумма снятия (расход)
- `Deposit` - Сумма пополнения (доход)
- `Balance` - Баланс после транзакции

### Запуск обучения

```bash
python scripts/train_transaction_classifier.py "путь/к/файлу/ci_data.csv"
```

С дополнительными параметрами:
```bash
python scripts/train_transaction_classifier.py "путь/к/файлу/ci_data.csv" --test-size 0.2
```

### Результаты обучения

После обучения модель сохраняется в `ml_models/transaction_classifier.pkl` и выводится отчет с метриками:
- Точность (Accuracy)
- Precision, Recall, F1-score для каждой категории
- Количество обучающих и тестовых примеров

## Использование модели

### Автоматическая классификация

Модель автоматически используется при создании новой транзакции через API, если категория не указана явно:

```python
from app.ml.categorizer import categorize_transaction
from datetime import datetime

category = categorize_transaction(
    description="3.00E+11",
    amount=100.0,
    is_expense=True,
    date=datetime.now()
)
```

### Ручная корректировка

Пользователь может вручную изменить категорию транзакции через API:

```http
PUT /transactions/{transaction_id}
Content-Type: application/json

{
  "category": "Продукты"
}
```

## Структура файлов

```
app/ml/
├── transaction_classifier.py  # Основной класс модели
├── categorizer.py             # Интерфейс для использования модели
└── ...

ml_models/
└── transaction_classifier.pkl  # Сохраненная обученная модель

scripts/
└── train_transaction_classifier.py  # Скрипт для обучения
```

## Производительность

Модель использует:
- **Random Forest** с 100 деревьями
- **TF-IDF** с максимум 100 признаками
- Оптимизирована для быстрого предсказания (< 10ms)

## Fallback режим

Если модель не обучена, используется простая эвристическая классификация на основе ключевых слов в описании.

## Обновление модели

Для переобучения модели на новых данных:
1. Подготовьте CSV файл с новыми данными
2. Запустите скрипт обучения
3. Модель автоматически перезапишется в `ml_models/transaction_classifier.pkl`

## Примечания

- Модель автоматически загружается при первом использовании
- Если модель не найдена, используется fallback классификация
- Ручная корректировка категорий пользователем не влияет на модель (можно добавить механизм дообучения в будущем)

